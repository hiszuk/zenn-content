---
title: "ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«Nuxtã«ç’°å¢ƒå¤‰æ•°ã‚’ä¸ãˆã‚‹ã«ã¯?"
emoji: "ğŸš¢"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Docker", "Nuxt", "axios"]
published: true
---
# å›°ã£ã¦ã„ã‚‹ã“ã¨

Nuxt.jsã§ã¯ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã€APIã®æ¥ç¶šå…ˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹å ´åˆã€buildæ™‚ã«å€¤ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¾ã™ã€‚
Nuxtã‚¢ãƒ—ãƒªã®Dockerã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã«pushã—ã¦ãŠãã€å®Ÿè¡Œæ™‚ã«ç’°å¢ƒã«å¿œã˜ãŸAPIæ¥ç¶šå…ˆã§ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èµ·å‹•ã—ãŸã„å ´åˆã€ãã‚Œã§ã¯ã†ã¾ãã„ãã¾ã›ã‚“ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ã€ŒNuxtã‚¢ãƒ—ãƒªã®Dockerã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èµ·å‹•ã™ã‚‹éš›ã«ã€ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ãŸAPIã®æ¥ç¶šå…ˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã«ã¯?ã€ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚

# ã‚„ã‚ŠãŸã„ã“ã¨

Nuxtã‚¢ãƒ—ãƒªã®Dockerã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èµ·å‹•ã™ã‚‹éš›ã€API_URLã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã«APIã®æ¥ç¶šå…ˆã‚’è¨­å®šã—ã€axiosã®baseURLã‚’ç’°å¢ƒå¤‰æ•°å€¤ã«è¨­å®šã—ã¾ã™ã€‚

```shell:ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚¤ãƒ¡ãƒ¼ã‚¸
$ docker run -d -e API_URL=http://hoge.staging:2000 -p 3000:3000 webapp:latest
```

`API_URL`ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã‚’å¤‰ãˆã‚‹ã“ã¨ã§æœ¬ç•ªï¼ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ï¼é–‹ç™ºç­‰ã®æ¥ç¶šå…ˆã‚’åˆ‡ã‚Šæ›¿ãˆãŸã„â€¦


# å®Ÿç¾æ–¹æ³•

æœ€åˆã«çµè«–ã‚’è¨€ã†ã¨ã€`nuxt-env` ã‚’ä½¿ã£ã¦å®Ÿè¡Œæ™‚ã®ç’°å¢ƒå¤‰æ•°ã‚’å–ã‚Šè¾¼ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

**å‚è€ƒè¨˜äº‹:**
https://dokuo.net/vue-js/nuxt-env/


**ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚½ãƒ¼ã‚¹(GitHub):**
https://github.com/hiszuk/nuxt-docker


## ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
ä»Šå›ã®å‹•ä½œç¢ºèªç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

### create-nuxt-app
create-nuxt-appã§ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã€‚
```shell
$ npx create-nuxt-app nuxt-sample
```
ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä»¥ä¸‹ã‚’é¸ã³ã¾ã—ãŸã€‚
```
create-nuxt-app v3.4.0
âœ¨  Generating Nuxt.js project in nuxt-sample
? Project name: nuxt-sample
? Programming language: JavaScript
? Package manager: Npm
? UI framework: None
? Nuxt.js modules: Axios
? Linting tools: ESLint, Prettier
? Testing framework: None
? Rendering mode: Universal (SSR / SSG)
? Deployment target: Server (Node.js hosting)
? Development tools: jsconfig.json (Recommended for VS Code if you're not using typescript)
? Continuous integration: None
? Version control system: Git
```
:::message
**Rendering mode**ã‚’SSR/SSGã«ã—ãªã„ã¨èµ·å‹•æ™‚ã«ç’°å¢ƒå¤‰æ•°æ¸¡ã™ã“ã¨ã¯å‡ºæ¥ã¾ã›ã‚“ã€‚
:::

`Linting tools` ã¯ãŠå¥½ã¿ã§ã€‚

### nuxt-envã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
å¼•ãç¶šã nuxt-sample ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã€nuxt-env ã‚’å…¥ã‚Œã¦ã„ãã¾ã™ã€‚
```shell
$ cd nuxt-sample
$ npm install nuxt-env
```

### nuxt.config.jsè¨­å®šè¿½åŠ 

configãƒ•ã‚¡ã‚¤ãƒ«ã«nuxt-envã€axiosã€pluginã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```javascript:nuxt-sample/nuxt.config.js
export default {
    // ç•¥
  plugins: [
    { src: '~/plugins/apiurl.js'}
  ],
    // ç•¥
  modules: [
    '@nuxtjs/axios',
    ['nuxt-env', { keys: [{ key: 'API_URL', default: 'http://localhost:2000' }] }]
  ],
    // ç•¥
}
```

- plugins/apiurl.js -> ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã—axiosã®baseURLã‚’è¨­å®šã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- ['nuxt-env'...ã€€->ã€€ç’°å¢ƒå¤‰æ•°å`API_URL`ã‚’è¿½åŠ ã—ã€åˆæœŸå€¤ã¨ã—ã¦`http://localhost:2000`ã‚’è¨­å®š

### pluginä½œæˆ

å®Ÿè¡Œæ™‚ã«è¨­å®šã•ã‚ŒãŸç’°å¢ƒå¤‰æ•°ã®å€¤ã‚’å–å¾—ã—ã€axiosã®baseURLã‚’è¨­å®šã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

```javascript:nuxt-sample/plugins/apiurl.js
export default (context) => {
  context.app.$axios.defaults.baseURL = context.app.$env.API_URL
}
```
- middleware/pluginã§å–å¾—ã™ã‚‹å ´åˆã€€->ã€€app.$env.XXXX
- vueã§å–å¾—ã™ã‚‹å ´åˆã€€->ã€€this.$env.XXXX

### å‹•ä½œç¢ºèªç”¨ã«index.vueä¿®æ­£

axiosã®baseURLã‚’å–å¾—ã—ã¦ã€ç’°å¢ƒå¤‰æ•°ã®å†…å®¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```vue:nuxt-sample/pages/index.vue
<template>
  <div class="container">
    <div>
      <Logo />
      <h1 class="title">nuxt-sample</h1>
      <h3>axios base url => {{ $axios.defaults.baseURL }}</h3>
      ç•¥
    </div>
  </div>
</template>
```

## Dockerã‚³ãƒ³ãƒ†ãƒŠåŒ–
ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã§Dockerã‚³ãƒ³ãƒ†ãƒŠåŒ–ã‚’è¡Œã„ã¾ã™ã€‚
```
./.dockerignore
./.gitignore
./Dockerfile
./nuxt-sample
    |-- :
```

### ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰

æ¬¡ã®Dockefileã§Nuxt.jsã®ã‚¢ãƒ—ãƒªã‚’ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã—ã¾ã™ã€‚

```yaml:Dockerfile
FROM node:14.15.3

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
RUN apt-get update

# NUXTã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
WORKDIR /webapp
COPY nuxt-sample /webapp

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å–å¾—ã—ãƒ“ãƒ«ãƒ‰
RUN npm install
RUN npm run build

ENV HOST 0.0.0.0

CMD ["npm", "run", "start"]

EXPOSE 3000
```

ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã€`sample/webapp:laetst` ã¨ã„ã†åå‰ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚
```sh:ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
$ docker image build -t sample/webapp:latest .
```

### å‹•ä½œç¢ºèª

- ç’°å¢ƒå¤‰æ•°ã«ä½•ã‚‚ä¸ãˆãªã„å ´åˆã¯`http://localhost:2000` ã¨ãªã‚‹ â¬

```sh:ç’°å¢ƒå¤‰æ•°ãªã—
docker run -d -p 3000:3000 sample/webapp:latest
```

![ç’°å¢ƒå¤‰æ•°ãªã—ã®å‹•ä½œç”»é¢](https://storage.googleapis.com/zenn-user-upload/3z6rm3vg6kcjfedo5tznjaewnvzm)
*ç’°å¢ƒå¤‰æ•°ãªã—ã®å‹•ä½œç”»é¢*

- ç’°å¢ƒå¤‰æ•°ã«`http://api.staging:3000` ã‚’ä¸ãˆãŸå ´åˆ â¬

```sh:ç’°å¢ƒå¤‰æ•°ã‚ã‚Š
docker run -d -e API_URL=http://api.staging:3000 -p 3000:3000 sample/webapp:latest
```

![ç’°å¢ƒå¤‰æ•°ã‚ã‚Šã®å‹•ä½œç”»é¢](https://storage.googleapis.com/zenn-user-upload/1fbf9urts19820yzweu8pj8ahxe9)
*ç’°å¢ƒå¤‰æ•°ã«http://api.staging:3000ã‚’è¨­å®šã—ãŸå ´åˆã®å‹•ä½œç”»é¢*

# ã¾ã¨ã‚

1. Nuxt.jsã§å®Ÿè¡Œæ™‚ã«ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€ã«ã¯`nuxt-env`ã‚’åˆ©ç”¨ã™ã‚‹
2. nuxt.config.jsã®modulesã§`nuxt-env`è¨­å®šã‚’è¿½åŠ ã™ã‚‹
3. `nuxt-env`è¨­å®šã§ã¯keysã«ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¿°ã™ã‚‹
4. ç’°å¢ƒå¤‰æ•°ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯`$env.XXXX`ã§å‚ç…§ã™ã‚‹


å‹˜é•ã„ã‚„ã€ã‚‚ã£ã¨è‰¯ã„æ–¹æ³•ãŒã‚ã‚‹å ´åˆã¯ã€ãœã²ã‚³ãƒ¡ãƒ³ãƒˆã«ã€‚
æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
