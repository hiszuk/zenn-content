---
title: "ãƒãƒ¼ã‚¿ãƒ«ç”»é¢ã«å€‹äººå‘ã‘é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹(å‰ç·¨)"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["SAML","keycloak","apache","Next","docker"]
published: true
---

# ã¯ã˜ã‚ã«

çš†ã•ã‚“ã¯ã€ãŠå‹¤ã‚ã®ä¼šç¤¾ã§ã€çµŒè²»ç²¾ç®—ã¯Aã‚·ã‚¹ãƒ†ãƒ ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯Bã‚·ã‚¹ãƒ†ãƒ ã€ç™ºæ³¨æ‰¿èªã¯Cã‚·ã‚¹ãƒ†ãƒ â€¦
ãã‚Œãã‚Œãƒ¡ãƒ¼ãƒ«ã§æ‰¿èªä¾é ¼ã¯æ¥ã‚‹ã‘ã©ã€ä»–ã®ãƒ¡ãƒ¼ãƒ«ã«åŸ‹ã‚‚ã‚Œã¦ã—ã¾ã£ã¦ã¤ã„å¿˜ã‚Œã¦ã—ã¾ã†ã€€ã¨ã„ã£ãŸäº‹æ•…ã®çµŒé¨“ã¯ã‚ã‚Šã¾ã›ã‹ï¼Ÿ
ãã‚Œãã‚Œã®ã‚·ã‚¹ãƒ†ãƒ ã¯SAMLèªè¨¼ã§ã‚·ãƒ³ã‚°ãƒ«ã‚µã‚¤ãƒ³ã‚ªãƒ³ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€å„ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã‘ã¦ã¿ãªã„ã¨ã‚„ã‚‹ã¹ãã“ã¨ãŒã©ã‚Œãã‚‰ã„æ®‹ã£ã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚‰ãªã„ã€‚

ãã“ã§ã€ã€é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã€ã®ç™»å ´ã§ã™ã€‚

ç¤¾å†…ã®SAMLèªè¨¼ã«å¯¾å¿œã—ãŸãƒãƒ¼ã‚¿ãƒ«ç”»é¢ã®ä¸€éƒ¨ã«ã€é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚’è¡¨ç¤ºã™ã‚‹`iframe`ã‚’åŸ‹ã‚è¾¼ã‚“ã§ã‚‚ã‚‰ã£ã¦ã€ãã“ã«Aã‚·ã‚¹ãƒ†ãƒ ãƒ»Bã‚·ã‚¹ãƒ†ãƒ ãƒ»Cã‚·ã‚¹ãƒ†ãƒ ã®æœªæ‰¿èªä»¶æ•°ã‚’è¡¨ç¤ºã•ã‚Œã‚Œã°ã€ã¨ã¦ã‚‚ãƒãƒƒãƒ”ãƒ¼ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã¨ã„ã†ã“ã¨ã§ã€ãã®ã€é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®æŠ€è¡“æ¤œè¨¼ã‚’è¡Œã„ã¾ã—ãŸã®ã§ã€è‡ªåˆ†ã®å‚™å¿˜éŒ²ã¨ã—ã¦è¨˜äº‹ã«ã—ã¾ã™ã€‚

# æŠ€è¡“æ¤œè¨¼ã®å‰æ

- SAMLèªè¨¼ã«ã¯`keycloak`ã‚’èªè¨¼ã‚µãƒ¼ãƒãƒ¼ã«ã™ã‚‹
- é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã®å‰æ®µã«`Apache`ã‚’æ§‹ãˆã¦ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·å…¼èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã™ã‚‹
- é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã¯`Next.js`ã§å®Ÿè£…ã—ã€å‰ç·¨ã§ã¯SAMLèªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã®ã¿ã¨ã™ã‚‹
- ãƒãƒ¼ã‚¿ãƒ«ã«é–¢ã—ã¦ã¯æ¤œè¨¼ç’°å¢ƒã§ã¯SAMLèªè¨¼ã«å¯¾å¿œã—ãªã„ã‚‚ã®ã¨ã™ã‚‹
ï¼ˆãã“ã‚‚SAMLèªè¨¼ã‚’å®Ÿè£…ã™ã‚‹ãƒ‘ãƒ¯ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰
- æœ¬è¨˜äº‹ã§ã¯SAMLèªè¨¼ã«ã¤ã„ã¦ã¯è¨€åŠã—ãªã„

SAMLèªè¨¼ã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã®è¨˜äº‹ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚
â¡ï¸ [SAMLèªè¨¼ã‚’å‹‰å¼·ã›ãšã«ç†è§£ã—ãŸã„ç§ã‹ã‚‰å‹‰å¼·ã›ãšã«ç†è§£ã—ãŸã„ç§ã¸](https://qiita.com/khsk/items/10a136bded197272094a)

# æ¤œè¨¼ç’°å¢ƒæ¦‚è¦

![æ¤œè¨¼ç’°å¢ƒ](https://storage.googleapis.com/zenn-user-upload/f4a4c1d8574b-20220312.png)

æ¤œè¨¼ç’°å¢ƒã«ã¤ã„ã¦ä¸Šå›³ã®ã‚ˆã†ãªç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

å‰ç·¨ã§ã¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€æœªèªè¨¼ã®å ´åˆã¯èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã®èªè¨¼ç”»é¢ãŒè¡¨ç¤ºã‚Œã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã¨ã“ã‚ã¾ã§æ§‹ç¯‰ã—ã¾ã™ã€‚é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€å‰ç·¨ã§ã¯å¤–éƒ¨ã®APIã¨ã®é€£æºã¯ã›ãšã€èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨ã“ã‚ã¾ã§ä½œã‚Šã¾ã™ã€‚

# æ§‹ç¯‰æ‰‹é †æ¦‚è¦

æ¤œè¨¼ç’°å¢ƒã¯æ¬¡ã®æ‰‹é †ã§å°‘ã—ã¥ã¤æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

1. `keycloak`ã‚’`docker-compose`ã§èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
   - `keycloak`ã‚’èµ·å‹•ã—æ¤œè¨¼ç”¨realmã€€`sample` ã‚’ä½œæˆ
   - `docker-compose`ã§èµ·å‹•æ™‚ã®ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
   - `keycloak`èµ·å‹•æ™‚ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
   - `sample realm`ã®ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹
2. é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹åˆç‰ˆã‚’èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
   - `create-next-app`ã§é››å½¢ã‚’ä½œæˆ
   - ãƒ˜ãƒƒãƒ€ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Œã°ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
   - é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚’`docker-compose`ã§èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
3. `Apache`ã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
   - ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã‚’ã—ãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
   - ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’`docker-compose`ã§èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
4. `Apache`ã§SAMLèªè¨¼ã§ãã‚‹ã‚ˆã†è¨­å®šã™ã‚‹
   - SAMLèªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã—ã¦éµãƒ»è¨¼æ˜æ›¸ãƒ»ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
   - SAMLèªè¨¼ã®è¨­å®šã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
5. `keycloak`ã«ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’è¿½åŠ 
   - ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™»éŒ²
   - ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¸æ¸¡ã™æƒ…å ±(ãƒ¦ãƒ¼ã‚¶ãƒ¼ID)ã®è¨­å®š
   - èµ·å‹•æ™‚ã®ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ä½œæˆ

---

# 1. `keycloak`ã‚’`docker-compose`ã§èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

å‚è€ƒè¨˜äº‹

> â¡ï¸ [Dockerã§Keycloakã‚’ã‚µã‚¯ãƒƒã¨ç«‹ã¦ã¦SAMLæ¤œè¨¼ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹](https://qiita.com/cold-wisteria/items/557c0d9bd34b9d638f58)
> â¡ï¸ [Keycloakã§SAMLã‚’ä½¿ã£ã¦ã¿ã‚‹ï¼ˆWordPressç·¨ï¼‰](https://qiita.com/katakura__pro/items/1e65e0bde7fda75332a1)
> â¡ï¸ [Keycloakã®è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€](https://qiita.com/shibukawa/items/70a60622c5cc596d355b)

### `keycloak`ã‚’èµ·å‹•ã™ã‚‹

ã¾ãšã¯ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`idp/setup`ã¨ã„ã†ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚

```
mkdir -p ./idp/setup
```

ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç›´ä¸‹ã«`docker-compose.yml`ã‚’ä½œæˆã—ã¾ã™ã€‚
```yaml:docker-compose.yml
version: "3"
services:
  keyclock:
    image: jboss/keycloak
    container_name: keycloak
    environment:
        KEYCLOAK_USER: admin
        KEYCLOAK_PASSWORD: admin
    ports:
        - 18080:8080
    volumes:
        - './idp/setup:/setup'
```
:::message alert
M1 Macã®å ´åˆä¸Šè¨˜ã§ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™
:::

:::details M1 Macã‚¨ãƒ©ãƒ¼å¯¾å¿œæ–¹æ³•

M1 Macã§ä¸Šè¨˜ `jboss/keycloak` ã‚’ãã®ã¾ã¾ä½¿ãˆã¾ã›ã‚“ã€‚
githubã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’cloneã—ã¦ã€imageã‚’buildã—ã¾ã™ã€‚


ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€`keycloak_build.sh`ã‚’ä½œã‚Šã¾ã™ã€‚
```sh:keycloak_build.sh
#/bin/zsh

VERSION=14.0.0 # set version here

cd /tmp
git clone https://github.com/keycloak/keycloak-containers.git
cd keycloak-containers/server
git checkout $VERSION
docker build -t "jboss/keycloak:${VERSION}" .
```
ãƒ‘ãƒ¼ãƒŸã‚·ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
```
chmod +x keycloak_build.sh
```

ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
```
./keycloak_build.sh
```

docker-compose.ymlã‚‚ä½œæˆã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°(jboss/keycloak:14.0.0)ã«æ›¸ãæ›ãˆã¦ãŠãã¾ã™ã€‚

:::

ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ˆã‚Š `docker-compose up -d`ã€€ã‚’å…¥åŠ›ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚

ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒæˆ»ã£ã¦ãã‚‹ã¨ã€`keycloak`ã®èµ·å‹•ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã¤ãŸã‚ã«ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

```
docker logs -f keycloak
```

ä¸‹è¨˜ã®ã‚ˆã†ã«ãƒãƒ¼ãƒˆã®ãƒªãƒƒã‚¹ãƒ³çŠ¶æ…‹ã«ãªã‚Œã°èµ·å‹•ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚

```
10:06:16,719 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: Keycloak 14.0.0 (WildFly Core 15.0.1.Final) started in 10881ms - Started 692 of 977 services (686 services are lazy, passive or on-demand)
10:06:16,720 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:9990/management
10:06:16,720 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:9990
```

èµ·å‹•ã‚’ç¢ºèªå¾Œã€`Ctrl+C` ã§ãƒ­ã‚°è¡¨ç¤ºã‚’çµ‚äº†ã—ã¾ã™ã€‚

èµ·å‹•ã§ãã¦ã„ã‚‹ã‹ã€ä»¥ä¸‹ã®URLã«ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

[http://localhost:18080/auth/admin/](http://localhost:18080/auth/admin/)

docker-compose.yml ã§è¨­å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

![login](/images/d3d5630bd4db327f2820/img01.png)

### æ¤œè¨¼ç”¨realmã€€`sample` ã‚’ä½œæˆã™ã‚‹

ç”»é¢å·¦ä¸Šã®ã€ŒMasterã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼éƒ¨åˆ†ã‚’ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã™ã‚‹ã¨ã€ŒAdd realmã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã€‚

![](/images/d3d5630bd4db327f2820/img02.png)

- Name: sample
- Enabled: ON

![](/images/d3d5630bd4db327f2820/img03.png)

ã€Œcreateã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹

![](/images/d3d5630bd4db327f2820/img04.png)

### `docker-compose`ã§èµ·å‹•æ™‚ã®ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
docker exec -it keycloak /opt/jboss/keycloak/bin/standalone.sh \
  -Djboss.socket.binding.port-offset=100 \
  -Dkeycloak.migration.action=export \
  -Dkeycloak.migration.provider=singleFile \
  -Dkeycloak.migration.realmName=sample \
  -Dkeycloak.migration.usersExportStrategy=REALM_FILE \
  -Dkeycloak.migration.file=/setup/sample_realm.json
```

`/setup/sample_realm.json` ãŒç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã‚Šã¾ã™ã€‚

ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºã¦æ­¢ã¾ã‚Œã°ã€Ctrl+Cã§æ­¢ã‚ã¾ã™ã€‚

```
11:34:40,637 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: Keycloak 14.0.0 (WildFly Core 15.0.1.Final) started in 6246ms - Started 594 of 872 services (584 services are lazy, passive or on-demand)
11:34:40,639 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:10090/management
11:34:40,639 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:10090
```

ä¸‹è¨˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`sample_realm.json` ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

`./idp/setup`

### `keycloak`èµ·å‹•æ™‚ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ä¸€åº¦ã€`keycloak`ã‚’æ­¢ã‚ã¾ã™ã€‚

```
docker-compose down
```

`docker-compose.yml`ã‚’ç·¨é›†ã—ã¦ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§èµ·å‹•ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```diff yml:docker-compose.yml
 version: "3"
 services:
   keyclock:
     image: jboss/keycloak:14.0.0
     container_name: keycloak
     environment:
       KEYCLOAK_USER: admin
       KEYCLOAK_PASSWORD: admin
+      KEYCLOAK_IMPORT: /setup/sample_realm.json
     ports:
       - 18080:8080
     volumes:
       - './idp/setup:/setup'
```

å†åº¦èµ·å‹•ã—ã€sampleãƒ¬ãƒ«ãƒ ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

```
docker-compose up -d
```

ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ä¸‹è¨˜ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](/images/d3d5630bd4db327f2820/img04.png)


###  `sample realm`ã®ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹

ä¸‹è¨˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€`keycloak`ã®ãƒ¡ã‚¿æƒ…å ±ã®XMLãŒå–å¾—ã§ãã¾ã™ã€‚

[http://localhost:18080/auth/realms/sample/protocol/saml/descriptor](http://localhost:18080/auth/realms/sample/protocol/saml/descriptor)

ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€ã‚’ä½œæˆã—ã¾ã™ã€‚

```
mkdir -p ./sp/saml
```

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ã‚’åå‰ã‚’ã¤ã‘ã¦ä¿å­˜ã™ã‚‹ã€€ã§`./sp/saml`ã«ä¿å­˜ã—ã¾ã™ã€‚
ã“ã®æ™‚ã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’`idp-metadata.xml`ã¨ã—ã¦ãŠãã¾ã™ã€‚

### èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã™ã‚‹

ã“ã“ã§ä¸€æ—¦èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã—ã¦ãŠãã¾ã™ã€‚

```
docker-compose down
```

# 2. é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹åˆç‰ˆã‚’èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ä»Šå›ã®é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã§ãƒ˜ãƒƒãƒ€ã«è¿½åŠ ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€SSRãƒ¢ãƒ¼ãƒ‰ã§`getServerSideProps`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§ã€`Next.js`ã‚’åˆ©ç”¨ã—ã¦é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚

###  `create-next-app`ã§é››å½¢ã‚’ä½œæˆ

```
npx create-next-app notify --typescript
```

èµ·å‹•ç¢ºèªã—ã¾ã™ã€‚

```
cd notify
yarn dev
```

[http://localhost:3000/](http://localhost:3000/)

ä¸Šè¨˜URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ä¸‹å›³ã®ã‚ˆã†ãªç”»é¢ãŒå‡ºåŠ›ã•ã‚Œã‚Œã°OKã§ã™ã€‚

![next start](/images/d3d5630bd4db327f2820/img05.png)

###  ãƒ˜ãƒƒãƒ€ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Œã°ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã™ã‚‹

ãƒšãƒ¼ã‚¸è¡¨ç¤ºã®å‰ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ID(`x-notify-user`)ã‚’å–ã‚Šå‡ºã—ã€Welcome to ã®å‰ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«`index.tsx`ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚

```diff javascript:./notify/pages/index.tsx
 import type { NextPage } from 'next'
 import Head from 'next/head'
 import Image from 'next/image'
 import styles from '../styles/Home.module.css'
 
+type Props = {
+  userid?: string
+}
+
+const Home: NextPage<Props> = ({ userid }: Props) => {
-const Home: NextPage = () => {
   return (
     <div className={styles.container}>
       <Head>
         <title>Create Next App</title>
         <meta name="description" content="Generated by create next app" />
         <link rel="icon" href="/favicon.ico" />
       </Head>
 
       <main className={styles.main}>
+        {userid !== 'NO ONE' && <div>Hi, {userid} !</div>}
         <h1 className={styles.title}>
           Welcome to <a href="https://nextjs.org">Next.js!</a>
         </h1>
         {/* ä¸­ç•¥ */}
         </div>
       </main>
 
       <footer className={styles.footer}>
         {/* ä¸­ç•¥ */}
       </footer>
     </div>
   )
 }
 
+export async function getServerSideProps({ req }: any) {
+  const userid: string = req.headers['x-notify-user'] || 'NO ONE'
+  return {
+    props: {
+      userid,
+    },
+  }
+}
+
 export default Home
 ```

é€šå¸¸ã®webãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ç¢ºèªã§ãã¾ã›ã‚“ãŒã€`Postman`ãŒã‚ã‚Œã°ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã«`X-Notify-User`ã‚’è¨­å®šã—ã¦GETã™ã‚Œã°ã€ã‚»ãƒƒãƒˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![postman](/images/d3d5630bd4db327f2820/img06.png)


`Ctrl+C`ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã—ã¾ã™ã€‚


###  é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚’`docker-compose`ã§èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

`src`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã— `pages`,`styles` ã‚’ãã®é…ä¸‹ã«ç§»å‹•ã™ã‚‹

```
./notify/src
|--pages
|  |--_app.tsx
|  |--api
|  |  |--hello.ts
|  |--index.tsx
|--styles
|  |--Home.module.css
|  |--globals.css
```

`./notify/Dockerfile`ã‚’ä½œã‚‹

```Dockerfile:./notify/Dockerfile
FROM node:16.13.1
WORKDIR /app
COPY package* yarn.lock ./
RUN yarn install
COPY public ./public
COPY src ./src
COPY tsconfig.json .eslint* next* ./
RUN yarn build

ENV HOST 0.0.0.0
EXPOSE 3000

CMD ["yarn", "start"]
```

`docker-compose.yml`ã«é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã™ã‚‹éƒ¨åˆ†ã‚’è¿½è¨˜ã™ã‚‹ã€‚

```diff yml:./docker-compose.yml
 version: "3"
 services:
   keyclock:
     image: jboss/keycloak:14.0.0
     container_name: keycloak
     environment:
       KEYCLOAK_USER: admin
       KEYCLOAK_PASSWORD: admin
       KEYCLOAK_IMPORT: /setup/sample_realm.json
     ports:
       - 18080:8080
     volumes:
       - './idp/setup:/setup'
+
+  notify:
+    image: saml/app:latest
+    build:
+      context: ./notify/
+      dockerfile: Dockerfile
+    container_name: notify
+    expose:
+      - 3000
+    ports:
+      - 3000:3000
+
```

ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§é€šçŸ¥ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

```
cd ..
docker-compose build notify
```

é€šçŸ¥ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ã€å‹•ä½œã‚’ç¢ºèªã—ã¾ã™ã€‚

```
docker-compose up -d
```

[http://localhost:3000/](http://localhost:3000/)

ä¸Šè¨˜URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¾ã™ã€‚
å‹•ä½œã«å•é¡Œãªã„ã“ã¨ã‚’ç¢ºèªã—ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¾ã™ã€‚

```
docker-compose down
```


# 3. `Apache`ã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

å‚è€ƒè¨˜äº‹

> â¡ï¸ [Docker Compose + Apache 2.4 ã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’ã™ã‚‹æœ€å°ã® httpd.conf](https://qiita.com/hoto17296/items/83e505a494b424006101)

###  ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã‚’ã—ãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™

ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã«å¿…è¦ãªè¨­å®šã‚’è¡Œã£ãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

`./sp/httpd.conf`

```apacheconf ./sp/httpd.conf
Listen 80

# å¿…é ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so

# root ã§å®Ÿè¡Œã—ãªã„ã‚ˆã†ã«ã™ã‚‹
LoadModule unixd_module modules/mod_unixd.so

User daemon
Group daemon

# ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ stderr ã«æµã™
ErrorLog /proc/self/fd/2

# ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’ stdout ã«æµã™
LoadModule log_config_module modules/mod_log_config.so
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
CustomLog /proc/self/fd/1 combined

# ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®š
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so

ProxyPass ${PROXY_PATH} ${PROXY_URL}
ProxyPassReverse ${PROXY_PATH} {$PROXY_URL}

# ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã‚’è¿½åŠ ã™ã‚‹
LoadModule headers_module modules/mod_headers.so
RequestHeader add X-Notify-User "test_user"
```

###  ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’`docker-compose`ã§èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’`./docker-compose.yml`ã«è¿½åŠ ã—ã¾ã™ã€‚

```diff yml:./docker-compose.yml
 version: "3"
 services:
   keyclock:
     image: jboss/keycloak:14.0.0
     container_name: keycloak
     environment:
       KEYCLOAK_USER: admin
       KEYCLOAK_PASSWORD: admin
       KEYCLOAK_IMPORT: /setup/sample_realm.json
     ports:
       - 18080:8080
     volumes:
       - './idp/setup:/setup'
 
   notify:
     image: saml/app:latest
     build:
       context: ./notify/
       dockerfile: Dockerfile
     container_name: notify
     expose:
       - 3000
-    ports:
-      - 3000:3000
+
+  proxy:
+    image: httpd:2.4
+    container_name: proxy
+    ports:
+      - 9000:80
+    volumes:
+      - ./sp/httpd.conf:/usr/local/apache2/conf/httpd.conf
+    environment:
+      PROXY_PATH: /
+      PROXY_URL: http://notify:3000/
+
```

ã“ã“ã§ä¸€åº¦ãƒ—ãƒ­ã‚­ã‚·ãŒå‹•ä½œã™ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚

```
docker-compose up -d
```

ä¸‹è¨˜URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€Nextã®åˆæœŸãƒšãƒ¼ã‚¸ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨OKã§ã™ã€‚
ã†ã¾ãè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ã¿ã¦ä¸‹ã•ã„ã€‚

[http://localhost:9000/](http://localhost:9000/)


![next top](/images/d3d5630bd4db327f2820/img07.png)

ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã§è¨­å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID(test_user)ãŒé€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã§å–å¾—ã§ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¾ã™ã€‚

```
docker-compose down
```


# 4. `Apache`ã§SAMLèªè¨¼ã§ãã‚‹ã‚ˆã†è¨­å®šã™ã‚‹

Apacheã§SAMLèªè¨¼ãŒã§ãã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ã„ãã¾ã™ã€‚

å‚è€ƒè¨˜äº‹

> â¡ï¸ [mod_auth_mellon ã‚’ä½¿ã£ã¦ã¿ãŸ](https://qiita.com/aimoto/items/89ba104db85a2b89fa67)
> â¡ï¸ [(SAMLç¬¬3å›) mod_auth_mellonã‚’ä½¿ã£ãŸç°¡æ˜“SPã®ä½œæˆ](https://security.sios.com/security/simplesamlphp-mellon-20210419.html)

###  SAMLèªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Apacheã«SAMLèªè¨¼ã«å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã«ã€`apache:2.4`ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚

`./sp/Dockerfile`ã‚’æ–°è¦ã«ä½œæˆã—ã¾ã™ã€‚

```Dockerfile:./sp/Dockerfile
FROM httpd:2.4

RUN apt-get update
RUN apt-get -y install libapache2-mod-auth-mellon openssl
RUN cp /usr/lib/apache2/modules/mod_auth_mellon.so /usr/local/apache2/modules/
```

`./sp/http.conf`ã«ã‚‚å¿…è¦ãªè¨­å®šã‚’è¿½è¨˜ã—ã¦ã„ãã¾ã™ã€‚
SAMLèªè¨¼ã®è¨­å®šã‚‚å¿…è¦ã§ã™ãŒã€ã¾ãšéµãƒ»è¨¼æ˜æ›¸ãƒ»ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ã‹ã‚‰å¾Œã§è¿½è¨˜ã™ã‚‹ã“ã¨ã¨ã—ã¾ã™ã€‚

```diff apacheconf:./sp/http.conf
 Listen 80
 
 # å¿…é ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
 LoadModule mpm_event_module modules/mod_mpm_event.so
 LoadModule authz_core_module modules/mod_authz_core.so
+LoadModule authn_file_module modules/mod_authn_file.so
+LoadModule authn_core_module modules/mod_authn_core.so
+LoadModule authz_host_module modules/mod_authz_host.so
+LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
+LoadModule authz_user_module modules/mod_authz_user.so
+LoadModule auth_basic_module modules/mod_auth_basic.so
  
 # root ã§å®Ÿè¡Œã—ãªã„ã‚ˆã†ã«ã™ã‚‹
 LoadModule unixd_module modules/mod_unixd.so
 
 User daemon
 Group daemon
 
 # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ stderr ã«æµã™
 ErrorLog /proc/self/fd/2
 
 # ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’ stdout ã«æµã™
 LoadModule log_config_module modules/mod_log_config.so
 LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
 CustomLog /proc/self/fd/1 combined
 
 # ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®š
 LoadModule proxy_module modules/mod_proxy.so
 LoadModule proxy_http_module modules/mod_proxy_http.so
 
 ProxyPass ${PROXY_PATH} ${PROXY_URL}
 ProxyPassReverse ${PROXY_PATH} {$PROXY_URL}
+
+# SAMLèªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨­å®š
+LoadModule auth_mellon_module modules/mod_auth_mellon.so
 
 # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã‚’è¿½åŠ ã™ã‚‹
 LoadModule headers_module modules/mod_headers.so
 RequestHeader add X-Notify-User "test_user"
```

`docker-compose.yml`ã«ã€ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼å†…ã§SAMLèªè¨¼ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®`./sp/saml`ã¨å…±æœ‰ã™ã‚‹ã‚ˆã†è¨­å®šã‚’è¿½åŠ ã™ã‚‹ã€‚
ã¾ãŸã€SAMLèªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã‚ˆã†å¤‰æ›´ã™ã‚‹ã€‚

```diff yaml:./docker-compose.yml(æŠœç²‹)
   proxy:
+    image: saml/sp:latest
+    build:
+      context: ./sp/
+      dockerfile: Dockerfile
-    image: httpd:2.4
     container_name: proxy
     ports:
       - 9000:80
     volumes:
       - ./sp/httpd.conf:/usr/local/apache2/conf/httpd.conf
+      - ./sp/saml:/usr/local/apache2/saml
     environment:
       PROXY_PATH: /
       PROXY_URL: http://notify:3000/
 ```

ãƒ—ãƒ­ã‚­ã‚·ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ä½œæˆã—ã¦ã‹ã‚‰ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã€‚

```
docker-compose build proxy
docker-compose up -d
```

###  ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã—ã¦éµãƒ»è¨¼æ˜æ›¸ãƒ»ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ

ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’SAMLèªè¨¼ã®SP(Service Provider)ã«ã™ã‚‹ãŸã‚ä¸‹è¨˜ã®é …ç›®ã‚’æ±ºå®šã—ã¾ã™ã€‚
æœ¬è¨˜äº‹ã¯æ¤œè¨¼ç›®çš„ã®ãŸã‚ã€æ­£å¼ãªFQDNã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã¯ãªãã€localhostã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

| é …ç›® | å€¤ | å‚™è€ƒ |
| --- | --- | --- |
| EntryID | http://localhost:9000 | SAML SPã®è­˜åˆ¥å­ |
| mellonå‹•ä½œãƒ‘ã‚¹ | /mellon | SAMLã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚‹ |
| ä¿è­·å¯¾è±¡ãƒ‘ã‚¹ | / | ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’è¡Œã†ãƒ‘ã‚¹ã‚’è¨­å®šã™ã‚‹ã€€|

SPãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚

ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Šã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```sh:ãƒ­ãƒ¼ã‚«ãƒ«
docker exec -it proxy bash
```

ã‚³ãƒ³ãƒ†ãƒŠå†…ã§æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

:::message
WEBè¨˜äº‹ã§ã¯`/usr/libexec/mod_auth_mellon/mellon_create_metadata.sh`ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ãŒã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã¯ã€`/usr/sbin/mellon_create_metadata`ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚
:::

```sh:ã‚³ãƒ³ãƒ†ãƒŠå†…
cd /usr/local/apache2/saml
mellon_create_metadata http://localhost:9000 http://localhost:9000/mellon
```

ä»¥ä¸‹ã®å‡ºåŠ›ãŒã‚ã‚Œã°OKã§ã™ã€‚

```
Output files:
Private key:               http_localhost_9000.key
Certificate:               http_localhost_9000.cert
Metadata:                  http_localhost_9000.xml

Host:                      localhost

Endpoints:
SingleLogoutService:       http://localhost:9000/mellon/logout
AssertionConsumerService:  http://localhost:9000/mellon/postResponse
```

ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰æŠœã‘ã¾ã™ã€‚

```
exit
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãæ›ãˆã®ãŸã‚ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¾ã™ã€‚

```
docker-compose down
```

###  SAMLèªè¨¼ã®è¨­å®šã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜

å…ˆã»ã©ä½œæˆã—ãŸéµãƒ»è¨¼æ˜æ›¸ãƒ»èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹(IdP)ã®ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šã‚’`./sp/http.conf`ã«å¯¾ã—ã¦è¿½è¨˜ã—ã¾ã™ã€‚

```diff apacheconf:./sp/http.conf
 Listen 80
 
 # å¿…é ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
 LoadModule mpm_event_module modules/mod_mpm_event.so
 LoadModule authz_core_module modules/mod_authz_core.so
 LoadModule authn_file_module modules/mod_authn_file.so
 LoadModule authn_core_module modules/mod_authn_core.so
 LoadModule authz_host_module modules/mod_authz_host.so
 LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
 LoadModule authz_user_module modules/mod_authz_user.so
 LoadModule auth_basic_module modules/mod_auth_basic.so
 
 # root ã§å®Ÿè¡Œã—ãªã„ã‚ˆã†ã«ã™ã‚‹
 LoadModule unixd_module modules/mod_unixd.so
 
 User daemon
 Group daemon
 
 # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ stderr ã«æµã™
 ErrorLog /proc/self/fd/2
 
 # ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’ stdout ã«æµã™
 LoadModule log_config_module modules/mod_log_config.so
 LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
 CustomLog /proc/self/fd/1 combined
 
 # ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®š
 LoadModule proxy_module modules/mod_proxy.so
 LoadModule proxy_http_module modules/mod_proxy_http.so
 
 ProxyPass ${PROXY_PATH} ${PROXY_URL}
 ProxyPassReverse ${PROXY_PATH} {$PROXY_URL}
 
 # SAMLèªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨­å®š
 LoadModule auth_mellon_module modules/mod_auth_mellon.so
 
+<Location />
+  MellonEndpointPath "/mellon"
+  MellonIdPMetadataFile /usr/local/apache2/saml/idp-metadata.xml
+  MellonSPPrivateKeyFile /usr/local/apache2/saml/http_localhost_9000.key
+  MellonSPCertFile /usr/local/apache2/saml/http_localhost_9000.cert
+  MellonSPMetadataFile /usr/local/apache2/saml/http_localhost_9000.xml
+
+  AuthType "Mellon"
+  Require valid-user
+  MellonEnable "auth"
+</Location>
+
 # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã‚’è¿½åŠ ã™ã‚‹
 LoadModule headers_module modules/mod_headers.so
+RequestHeader add X-Notify-User %{MELLON_username}e env=MELLON_username
-RequestHeader add X-Notify-User "test_user"
```

MELLON_ä»¥é™ãŒKeycloakã§è¨­å®šã™ã‚‹å±æ€§åã«ãªã‚‹ã€‚

# 5. `keycloak`ã«ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’è¿½åŠ 

keycloakkã«ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ãƒ¡ã‚¿æƒ…å ±ã‚’ç™»éŒ²ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’è¡Œã„ã¾ã™ã€‚

###  ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™»éŒ²

ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚

```
docker-compose up -d
```

ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’èµ·å‹•ã—ã¾ã™ã€‚

[http://localhost:18080/auth/admin](http://localhost:18080/auth/admin)

èµ·å‹•å¾Œã€å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒClientsã€ã‚’é¸æŠã—ã¾ã™ã€‚

![client menu](/images/d3d5630bd4db327f2820/img08.png)

ã€ŒClientsã€ç”»é¢ã®å³ã«ã‚ã‚‹ã€ŒCreateã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ç™»éŒ²ã™ã‚‹ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

![ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€è¿½åŠ ](/images/d3d5630bd4db327f2820/img09.png)

ã€ŒSelect fileã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€4.ã€€ã§ç”Ÿæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãå´ã®ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(`http_localhost_9000.xml`)ã‚’æŒ‡å®šã—ã¾ã™ã€‚

:::message
ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€`./sp/saml` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™
:::

![ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿](/images/d3d5630bd4db327f2820/img10.png)

ã€ŒSaveã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

![ãƒãƒƒãƒ”ãƒ³ã‚°æŒ‡å®š](/images/d3d5630bd4db327f2820/img11.png)

ã€ŒMapperã€ã‚¿ãƒ–ã‚’é¸æŠã—ã€ã€ŒCreateã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ–°ã—ããƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

![ãƒãƒƒãƒ”ãƒ³ã‚°æŒ‡å®š](/images/d3d5630bd4db327f2820/img12.png)

- Name : username
- Mapper Type : User Property
- Property : username
- SAML Attribute : username ï¼ˆApacheç’°å¢ƒå¤‰æ•°ã®MELLON_ä»¥é™ã¨ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ï¼‰
- SAML Attribute NameFormat : Basic

ã€ŒSaveã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨­å®šã‚’ä¿å­˜ã—ã¾ã™ã€‚

###  ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¸æ¸¡ã™æƒ…å ±(ãƒ¦ãƒ¼ã‚¶ãƒ¼ID)ã®è¨­å®š

![ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ³ãƒ†](/images/d3d5630bd4db327f2820/img13.png)

ç®¡ç†ç”»é¢TOPã«æˆ»ã‚Šã€å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒUsersã€ã‚’é¸æŠã—ã€è¡¨ç¤ºã•ã‚Œã‚‹ã€ŒUsersã€ç”»é¢å³ã®ã€ŒAdd userã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ](/images/d3d5630bd4db327f2820/img14.png)

- Username: ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆä»Šå›ã¯GitHubã«æ¥ç¶šã™ã‚‹ã®ã§ãã®IDã‚’è¨­å®šï¼‰
- Email: ä»»æ„ã§è¨­å®šã—ã¾ã™ã€‚ï¼ˆä»Šå›ã®æ¤œè¨¼ã§ã¯ä½¿ç”¨ã—ã¾ã›ã‚“ï¼‰
- First Name: ä»»æ„ã§è¨­å®šã—ã¾ã™ã€‚ï¼ˆä»Šå›ã®æ¤œè¨¼ã§ã¯ä½¿ç”¨ã—ã¾ã›ã‚“ï¼‰
- Last Name: ä»»æ„ã§è¨­å®šã—ã¾ã™ã€‚ï¼ˆä»Šå›ã®æ¤œè¨¼ã§ã¯ä½¿ç”¨ã—ã¾ã›ã‚“ï¼‰
- User Enabled: ONï¼ˆåˆæœŸå€¤ã§ã™ï¼‰

ã€ŒSaveã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨­å®šã‚’ä¿å­˜ã—ã¾ã™ã€‚

![ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ](/images/d3d5630bd4db327f2820/img15.png)

ã€ŒCredentialsã€ã‚¿ãƒ–ã‚’é¸æŠã™ã‚‹ã¨ä¸Šè¨˜è¡¨ç¤ºã«ãªã‚‹ã®ã§ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒãƒˆã—ã€$\textcolor{red}{Temporaryã‚’OFF}$ã«ã—ã¦ã€ã€ŒSet Passwordã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

###  èµ·å‹•æ™‚ã®ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ä½œæˆ

docker-composeã§ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã•ã‚ŒãŸæ™‚ã«èª­ã¿è¾¼ã‚€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã™ã€‚
ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰å®Ÿè¡Œã—ã¾ã™ã€‚

```
docker exec -it keycloak /opt/jboss/keycloak/bin/standalone.sh \
  -Djboss.socket.binding.port-offset=100 \
  -Dkeycloak.migration.action=export \
  -Dkeycloak.migration.provider=singleFile \
  -Dkeycloak.migration.realmName=sample \
  -Dkeycloak.migration.usersExportStrategy=REALM_FILE \
  -Dkeycloak.migration.file=/setup/sample_realm.json
```

```
..... WFLYSRV0051: Admin console listening on http://127.0.0.1:10090
```

ä¸Šè¨˜è¡¨ç¤ºã§å‡ºåŠ›ãŒæ­¢ã¾ã‚Œã°ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ä½œæˆã•ã‚Œã¦ã„ã‚‹ã®ã§ã€Ctrl+Cã§æ­¢ã‚ã¾ã™ã€‚

ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã€œèµ·å‹•ã—ã€è¨­å®šå†…å®¹ãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
docker-compose down

docker-compose up -d
```

ketcloakãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

```
docker logs -f keycloak
```

```
..... WFLYSRV0051: Admin console listening on http://127.0.0.1:10090
```
ä¸Šè¨˜è¡¨ç¤ºã§å‡ºåŠ›ãŒæ­¢ã¾ã‚Œã°ã€èµ·å‹•å®Œäº†ã—ã¦ã„ã¾ã™ã®ã§ã€Ctrl+Cã§æ­¢ã‚ã¾ã™ã€‚

ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’èµ·å‹•ã—ã¾ã™ã€‚

[http://localhost:18080/auth/admin](http://localhost:18080/auth/admin)

![](/images/d3d5630bd4db327f2820/img16.png)

Clients ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ã€Œhttp://localhost:9000ã€ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](/images/d3d5630bd4db327f2820/img17.png)

ã€Œhttp://localhost:9000ã€ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ŒMapperã€ã‚¿ãƒ–ã‚’é¸æŠã—ã€ã€Œusernameã€ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](/images/d3d5630bd4db327f2820/img18.png)

ã€Œusernameã€ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](/images/d3d5630bd4db327f2820/img19.png)

ã€ŒUsersã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒView all usersã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

### é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã®SAMLèªè¨¼ç¢ºèª

æœ€å¾Œã«ã€é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã§SAMLèªè¨¼ã®å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚

æ¬¡ã®ã‚ˆã†ãªå‹•ä½œã«ãªã‚Œã°OKã§ã™ã€‚

1. [http://localhost:9000](http://localhost:9000)ã«ã‚¢ã‚¯ã‚»ã‚¹
â¡ï¸ keycloakã®sampleãƒ¬ãƒ«ãƒ ã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
![](/images/d3d5630bd4db327f2820/img20.png)
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—Sign Inãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
â¡ï¸ é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹TOPãŒè¡¨ç¤ºã•ã‚Œã€ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
![](/images/d3d5630bd4db327f2820/img21.png)
3. åŒã˜ãƒ–ãƒ©ã‚¦ãœã§åˆ¥ã‚¿ãƒ–ã‚’é–‹ã[http://localhost:9000](http://localhost:9000)ã«ã‚¢ã‚¯ã‚»ã‚¹
â¡ï¸ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’çµŒç”±ã›ãšã«é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹

# æœ€å¾Œã«

é•·ã„è¨˜äº‹ã«æœ€å¾Œã¾ã§ãŠä»˜ãåˆã„ã„ãŸã ãã¾ã—ã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
ã“ã‚Œã§ã€ä¸€é€šã‚ŠSAMLèªè¨¼ãŒå®Ÿè£…ã•ã‚ŒãŸé€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã®ç’°å¢ƒæ§‹ç¯‰ãŒã§ãã¾ã—ãŸã€‚

å¾Œç·¨ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã‚’è€ƒãˆã¦ã„ã¾ã™ã€‚
- é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹å†…ã§GitHubã®APIã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚¹ã‚¿ãƒ¼æ•°ã‚’å–å¾—ã—ã‚¢ã‚¤ã‚³ãƒ³ã«ã‚¹ã‚¿ãƒ¼æ•°ã‚’ãƒãƒƒã‚¸è¡¨ç¤ºã™ã‚‹
- ãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆã®iframeã‹ã‚‰é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦ãƒãƒƒãƒä»˜ãã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹

